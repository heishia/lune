## 1. 개요

- **목표**: 기존 Supabase Edge Functions(`make-server-8ed17d84`)로 구현되어 있던 최소 쇼핑몰 백엔드를, 이 프로젝트의 `backend/` 폴더(FastAPI 가정)를 사용해 **필수 기능만** 옮겨오기 위한 설계 문서입니다.
- **원칙**
  - 프론트엔드가 실제로 호출하는 API 중 **쇼핑몰 핵심 흐름에 필요한 것만** 대상으로 합니다.
  - 회원가입/로그인, 상품 목록·상세, 장바구니, 주문 생성/조회 정도까지만 포함합니다.
  - 리뷰, 쿠폰, 위시리스트, 알림, 인스타그램 연동 등은 **이번 단계 범위에서 제외**하고, 확장 포인트로만 언급합니다.
- **참고 기준**
  - 프론트: `frontend/src/utils/api.ts`, `App.tsx`, 각 페이지/컴포넌트들
  - 기존 Supabase Functions: `frontend/src/supabase/functions/server/*.tsx`
  - DB 스키마: `database/DATABASE_SCHEMA.sql`, `database/database_setup.md`

---

## 2. 전체 아키텍처 요약

- **Frontend (Vite + React/TS)**
  - 현재는 `https://{projectId}.supabase.co/functions/v1/make-server-8ed17d84` 기준으로 API 호출
  - 향후 단계에서 이 베이스 URL을 FastAPI 백엔드의 도메인/프리픽스로 교체 예정 (예: `https://api.lune.com`)

- **Backend (FastAPI 예정, 이 레포의 `backend/`)**
  - 도메인별 라우터 구조:
    - `auth`: 회원가입/로그인/내 정보
    - `products`: 상품 조회 + 관리자 상품 CRUD
    - `cart`: 장바구니
    - `orders`: 주문 생성/조회/취소
  - 공통 모듈:
    - `backend/core/database.py`: DB 연결 및 세션 관리
    - `backend/core/models.py`: ORM 엔티티 정의
    - `backend/core/security.py`: JWT 발급/검증, 인증 의존성

- **Database (PostgreSQL / Supabase 호환)**
  - 이미 제공된 스키마를 기반으로, 이번 단계에서는 다음 테이블만 사용:
    - `users`, `products`, `carts`, `orders`, `order_items`

---

## 3. 백엔드 폴더 구조 및 도메인 매핑 설계

현재 `backend/`에는 `feature1`, `feature2`, `feature3` 폴더가 있습니다. 이들은 실제 구현 시 아래와 같이 **역할 기반 도메인 폴더**로 사용합니다.

- **기존 → 목표 도메인 매핑**
  - `backend/feature1` → `backend/products`
  - `backend/feature2` → `backend/cart`
  - `backend/feature3` → `backend/orders`

실제 폴더명 변경과 구현은 이후 단계에서 진행하고, 이 문서에서는 각 도메인의 **역할과 라우트 계약만** 정의합니다.

### 3.1. 공통/코어 모듈

- `backend/core/database.py`
  - DB 엔진/세션 팩토리, 의존성 (`get_db`) 제공.
- `backend/core/models.py`
  - `User`, `Product`, `Cart`, `Order`, `OrderItem` 엔티티 정의.
- `backend/core/security.py`
  - 비밀번호 해시/검증, JWT 발급/검증.
  - FastAPI `Depends` 기반 인증 의존성 (`get_current_user`) 제공.
- `backend/main.py`
  - FastAPI 앱 생성 및 라우터 마운트:
    - `/auth` → `auth.router`
    - `/products` → `products.router`
    - `/cart` → `cart.router`
    - `/orders` → `orders.router`

### 3.2. `backend/auth`

- `router.py`
  - 회원가입/로그인/내 정보 조회용 HTTP 엔드포인트 정의.
- `schemas.py`
  - `SignupRequest`, `LoginRequest`, `AuthResponse`, `MeResponse` 등 Pydantic 스키마.
- `service.py`
  - 사용자 생성, 로그인 검증, 토큰 발급 등의 비즈니스 로직.

### 3.3. `backend/products` (기존 `feature1`)

- `router.py`
  - 상품 목록/상세 조회, 관리자 상품 CRUD 엔드포인트 정의.
- `schemas.py`
  - `Product`, `ProductsResponse`, `CreateProductRequest`, `UpdateProductRequest` 등.
- `service.py`
  - 검색/필터링, 페이징, 상품 생성/수정/삭제 로직.
- `models.py`
  - `Product` 엔티티가 `core.models`의 공통 `Product`를 그대로 사용할 경우, 별도 파일 없이 재사용해도 됨.

### 3.4. `backend/cart` (기존 `feature2`)

- `router.py`
  - 장바구니 CRUD (조회/추가/수량변경/삭제/전체삭제).
- `schemas.py`
  - `CartItem`, `AddToCartRequest`, `CartResponse` 등.
- `service.py`
  - 사용자별 장바구니 관리, 상품/재고 검증 등 최소 로직.

### 3.5. `backend/orders` (기존 `feature3`)

- `router.py`
  - 주문 생성, 주문 목록 조회, 주문 상세 조회, 주문 취소.
- `schemas.py`
  - `OrderItemPayload`, `ShippingAddressPayload`, `CreateOrderRequest`, `OrderSummary`, `OrderDetail` 등.
- `service.py`
  - 주문번호 생성, 금액 계산, 주문/주문상품 생성, 장바구니 연동, 취소 규칙 처리.

---

## 4. 데이터베이스 최소 스키마

이미 제공된 SQL 스키마를 기반으로, 이번 단계에서 실제로 사용하는 최소 컬럼만 정리합니다. 타입은 PostgreSQL 기준의 개략적인 형태입니다.

### 4.1. `users` (회원)

- **목적**: 이메일/비밀번호 기반 로그인 및 사용자 정보 저장.
- **주요 컬럼**
  - `id` (UUID, PK)
  - `email` (varchar, unique)
  - `name` (varchar)
  - `password_hash` (varchar)
  - `phone` (varchar)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)
  - `last_login` (timestamp, 선택)
  - `is_active` (boolean, 기본값 true)
  - `marketing_agreed` (boolean, 기본값 false)

### 4.2. `products` (상품)

- **목적**: 상품 목록/상세/관리자용 CRUD.
- **프론트 참조 타입**: `frontend/src/utils/api.ts` 의 `Product` 인터페이스와 1:1 매핑.
- **주요 컬럼**
  - `id` (serial, PK)
  - `name` (varchar)
  - `description` (text)
  - `price` (integer)
  - `original_price` (integer, nullable)
  - `category` (text[]; 예: `["TOP","BEST"]`)
  - `colors` (text[])
  - `sizes` (text[])
  - `image_url` (text)
  - `stock_quantity` (integer, 기본값 0)
  - `is_new` (boolean, 기본값 false)
  - `is_best` (boolean, 기본값 false)
  - `is_active` (boolean, 기본값 true)
  - `view_count` (integer, 기본값 0)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)

### 4.3. `carts` (장바구니)

- **목적**: 로그인한 사용자의 장바구니 상태 저장.
- **프론트 참조 타입**: `api.ts` 의 `CartItem` (백엔드 응답 기준).
- **주요 컬럼**
  - `id` (UUID, PK)
  - `user_id` (UUID, FK → `users.id`)
  - `product_id` (integer, FK → `products.id`)
  - `quantity` (integer, 1 이상)
  - `color` (varchar)
  - `size` (varchar)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)
  - **제약 조건**
    - `(user_id, product_id, color, size)` 유니크

### 4.4. `orders` (주문)

- **목적**: 주문 헤더(금액, 배송 정보, 상태 등).
- **프론트 참조 타입**: `api.ts` 의 `Order` 타입과 매핑.
- **주요 컬럼**
  - `id` (UUID, PK)
  - `user_id` (UUID, FK → `users.id`)
  - `order_number` (varchar, unique) – `YYYYMMDD-랜덤` 형식
  - `status` (varchar, 기본값 `pending`)
  - `total_amount` (integer) – 상품 총액
  - `discount_amount` (integer, 기본값 0)
  - `shipping_fee` (integer, 기본값 3000)
  - `final_amount` (integer) – 최종 결제 금액
  - `recipient_name` (varchar)
  - `recipient_phone` (varchar)
  - `postal_code` (varchar)
  - `address` (varchar)
  - `address_detail` (varchar, nullable)
  - `delivery_message` (text, nullable)
  - `payment_method` (varchar)
  - `payment_status` (varchar, 기본값 `pending`)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)

### 4.5. `order_items` (주문 상품)

- **목적**: 주문별 상품 상세 내역.
- **주요 컬럼**
  - `id` (UUID, PK)
  - `order_id` (UUID, FK → `orders.id`, on delete cascade)
  - `product_id` (integer, FK → `products.id`)
  - `product_name` (varchar) – 주문 시점의 스냅샷
  - `product_image` (text)
  - `quantity` (integer)
  - `color` (varchar)
  - `size` (varchar)
  - `price` (integer) – 주문 당시 단가
  - `created_at` (timestamp)

> 참고: `wishlists`, `addresses`, `reviews`, `coupons` 등은 현재 프론트에서 필수 흐름으로 사용하지 않으므로, 이 단계 스코프에서 제외합니다.

---

## 5. 인증 및 보안 정책 (최소)

### 5.1. 토큰 구조

- **형태**: JWT (JSON Web Token)
- **페이로드 필드 예시**
  - `sub`: 사용자 ID (`users.id`)
  - `email`: 사용자 이메일
  - `exp`: 만료 시각 (예: 발급 후 7일)

### 5.2. 인증 헤더 규칙

- 프론트는 `frontend/src/utils/api.ts` 에서 다음과 같이 요청을 보냅니다.
  - `Authorization: Bearer <token>` (로그인 후)
  - 로그인 전에는 현재 `publicAnonKey`를 사용하지만, **새 백엔드에서는 공개 엔드포인트는 토큰 없이 접근 가능**하게 설계합니다.

### 5.3. 엔드포인트별 인증 필요 여부

- **인증 불필요 (공개)**
  - `POST /auth/signup`
  - `POST /auth/login`
  - `GET /products`
  - `GET /products/{id}`

- **인증 필요 (JWT)**
  - `GET /auth/me`
  - `GET /cart`
  - `POST /cart`
  - `PUT /cart/{cart_id}`
  - `DELETE /cart/{cart_id}`
  - `DELETE /cart`
  - `POST /orders`
  - `GET /orders`
  - `GET /orders/{order_id}`
  - `PUT /orders/{order_id}/cancel`

관리자용 상품 관리 엔드포인트 (`POST/PUT/DELETE /products`)는 단순화를 위해 **초기에는 토큰 기반 관리자 인증(예: 별도 관리자 플래그)** 으로만 설계해두고, 상세 정책은 이후 단계에서 정의합니다.

---

## 6. 엔드포인트 설계 (프론트 기준 최소)

아래는 Supabase Functions에서 사용하던 경로를 FastAPI로 옮겼을 때의 **기본 계약**입니다. 실제 서버 베이스 URL은 환경에 따라 달라지고, 여기서는 `/` 기준 상대 경로만 표기합니다.

### 6.1. Auth (`/auth`)

#### 6.1.1. 회원가입

- **메소드/경로**: `POST /auth/signup`
- **인증**: 없음
- **요청 바디 필드 (프론트 `SignupData`)**
  - `email` (string)
  - `password` (string)
  - `name` (string)
  - `phone` (string)
  - `marketingAgreed` (boolean, 선택)
- **성공 응답 (`AuthResponse`)**
  - `success` (boolean)
  - `user`:
    - `id` (string, UUID)
    - `email` (string)
    - `name` (string)
  - `token` (string, JWT)
- **오류 응답**
  - 형식: `{ "error": "메시지" }`

#### 6.1.2. 로그인

- **메소드/경로**: `POST /auth/login`
- **인증**: 없음
- **요청 바디 필드 (`LoginData`)**
  - `email` (string)
  - `password` (string)
- **성공 응답**: 회원가입과 동일한 `AuthResponse`
- **오류 응답**
  - `401` – 이메일/비밀번호 불일치
  - `400` – 필드 누락 등

#### 6.1.3. 내 정보 조회

- **메소드/경로**: `GET /auth/me`
- **인증**: 필요 (Authorization: Bearer 토큰)
- **성공 응답**
  - `{ "user": { "id", "email", "name", "phone", "created_at", "marketing_agreed" } }`
- **오류 응답**
  - `401` – 토큰 없음/검증 실패

---

### 6.2. Products (`/products`)

#### 6.2.1. 상품 목록 조회

- **메소드/경로**: `GET /products`
- **인증**: 없음
- **쿼리 파라미터 (선택)**
  - `category` (string)
  - `search` (string)
  - `page` (number)
  - `limit` (number)
- **성공 응답 (`ProductsResponse`)**
  - `products`: `Product[]`
  - `total`: 전체 개수 (number)
  - `page`: 현재 페이지 (number)
  - `totalPages`: 총 페이지 수 (number)
- **`Product` 필드**
  - `id`, `name`, `description`, `price`, `original_price`, `category[]`, `colors[]`,
    `sizes[]`, `image_url`, `stock_quantity`, `is_new`, `is_best`, `view_count`, `created_at`

#### 6.2.2. 상품 상세 조회

- **메소드/경로**: `GET /products/{id}`
- **인증**: 없음
- **성공 응답**
  - `Product` 기본 필드 +
  - `reviews`: 배열 (이번 단계에서는 빈 배열 또는 더미)
  - `reviewCount`: number
  - `averageRating`: number
  - 리뷰 관련 값은 **프론트 UI가 깨지지 않도록 기본값만 제공**하고, 실제 리뷰 기능은 이후 확장.

#### 6.2.3. 상품 생성 (관리자용)

- **메소드/경로**: `POST /products`
- **인증**: 필요 (관리자 권한 JWT, 최소한 토큰 기반)
- **요청 바디**
  - `Product`에서 `id`, `created_at`, `view_count` 를 제외한 필드.
- **성공 응답**
  - `{ "product": Product }`

#### 6.2.4. 상품 수정 (관리자용)

- **메소드/경로**: `PUT /products/{id}`
- **인증**: 필요 (관리자)
- **요청 바디**
  - 부분 업데이트 허용 (`Product`의 일부 필드만 포함 가능).
- **성공 응답**
  - `{ "product": Product }`

#### 6.2.5. 상품 삭제 (관리자용)

- **메소드/경로**: `DELETE /products/{id}`
- **인증**: 필요 (관리자)
- **성공 응답**
  - `{ "success": true }`

---

### 6.3. Cart (`/cart`)

#### 6.3.1. 장바구니 조회

- **메소드/경로**: `GET /cart`
- **인증**: 필요
- **성공 응답**
  - `{ "items": CartItem[] }`
- **`CartItem` 필드 (백엔드 응답 기준)**
  - `id` (string, 장바구니 아이템 ID)
  - `product_id` (number)
  - `quantity` (number)
  - `color` (string)
  - `size` (string)
  - `created_at` (string)
  - `products`: `Product` – 조인된 상품 정보

#### 6.3.2. 장바구니에 상품 추가

- **메소드/경로**: `POST /cart`
- **인증**: 필요
- **요청 바디 (`AddToCartData`)**
  - `productId` (number)
  - `quantity` (number)
  - `color` (string)
  - `size` (string)
- **성공 응답**
  - `{ "item": CartItem }`

#### 6.3.3. 장바구니 수량 수정

- **메소드/경로**: `PUT /cart/{cart_id}`
- **인증**: 필요
- **요청 바디**
  - `quantity` (number)
- **성공 응답**
  - `{ "item": CartItem }`

#### 6.3.4. 개별 아이템 삭제

- **메소드/경로**: `DELETE /cart/{cart_id}`
- **인증**: 필요
- **성공 응답**
  - `{ "success": true }`

#### 6.3.5. 장바구니 전체 비우기

- **메소드/경로**: `DELETE /cart`
- **인증**: 필요
- **성공 응답**
  - `{ "success": true }`

---

### 6.4. Orders (`/orders`)

#### 6.4.1. 주문 생성

- **메소드/경로**: `POST /orders`
- **인증**: 필요
- **요청 바디 (`CreateOrderData`)**
  - `items`: 배열
    - `productId` (number)
    - `quantity` (number)
    - `color` (string)
    - `size` (string)
  - `shippingAddress`:
    - `recipientName`, `phone`, `postalCode`, `address`, `addressDetail?`, `deliveryMessage?`
  - `paymentMethod` (string)
  - `discountAmount?` (number)
- **성공 응답**
  - `{ "orderId": string, "orderNumber": string, "totalAmount": number }`

#### 6.4.2. 주문 목록 조회

- **메소드/경로**: `GET /orders`
- **인증**: 필요
- **쿼리 파라미터 (선택)**
  - `page` (number, 기본 1)
  - `limit` (number, 기본 10)
  - `status` (string, 선택)
- **성공 응답**
  - `orders`: `Order[]`
  - `total`: number
  - `page`: number
  - `totalPages`: number
- **`Order` 필드 (요약)**
  - `id`, `order_number`, `status`, `total_amount`, `discount_amount`,
    `shipping_fee`, `final_amount`, `recipient_name`, `recipient_phone`,
    `postal_code`, `address`, `address_detail?`, `delivery_message?`,
    `payment_method`, `payment_status`, `created_at`

#### 6.4.3. 주문 상세 조회

- **메소드/경로**: `GET /orders/{order_id}`
- **인증**: 필요
- **성공 응답**
  - `Order` 기본 필드 +
  - `items`: 주문 상품 배열 (`order_items` 조인)

#### 6.4.4. 주문 취소

- **메소드/경로**: `PUT /orders/{order_id}/cancel`
- **인증**: 필요
- **요청 바디**
  - `reason` (string)
- **성공 응답**
  - `{ "success": true }`

---

## 7. 주요 유저 플로우 (최소 구현 기준)

### 7.1. 비로그인 사용자

1. 홈/카테고리/상품 그리드 진입:
   - 프론트: `ProductGrid`, `CategoryPage`, `HeroSection` 등에서 `GET /products` 호출.
2. 상품 상세 페이지:
   - 프론트: `ProductDetail`에서 `GET /products/{id}` 호출.
3. 장바구니 담기:
   - **이번 단계 최소 구현에서는 로그인 사용자 기준으로만 장바구니를 지원**합니다.
   - 비로그인은 프론트 로컬 상태로만 장바구니를 사용하고, 백엔드 연동은 로그인 후로 제한할 수 있습니다.

### 7.2. 로그인 사용자

1. 로그인:
   - `POST /auth/login` → 토큰 저장 (프론트 `setToken`, `setUserInfo`).
2. 장바구니:
   - `GET /cart` / `POST /cart` / `PUT /cart/{id}` / `DELETE /cart/{id}` / `DELETE /cart`.
3. 주문 생성:
   - `CheckoutPage`에서 결제 버튼 → `POST /orders`.
4. 주문 내역 조회:
   - `AccountPage` 의 주문 탭이 실제 주문 데이터를 사용하도록 하는 것은 **추후 단계**에서 구현 가능하며,
     현재는 임시 데이터 기반 UI를 유지합니다.

### 7.3. 관리자

1. 관리자 로그인:
   - 현재 프론트에서는 단순 폼/상수 기반(문서 기준)이며, 백엔드에서 별도 관리자 권한을 가질 수 있습니다.
2. 상품 관리:
   - `AdminPage`에서
     - 목록: `GET /products?category=...&limit=100`
     - 추가: `POST /products`
     - 수정: `PUT /products/{id}`
     - 삭제: `DELETE /products/{id}`
3. 주문 관리:
   - 현재 프론트는 **임시 Mock 데이터**를 사용 중이며, 실제 주문 데이터 연동은 이후 확장 단계에서 다룹니다.

---

## 8. 범위 밖 기능 및 확장 포인트

현재 프론트 코드 상 존재하지만, **이번 최소 백엔드 설계에서 의도적으로 제외**한 기능들은 다음과 같습니다.

- **위시리스트 / 즐겨찾기**
  - Supabase Functions 기준:
    - `POST /favorites`, `GET /favorites`, `DELETE /favorites/{productId}`, `GET /favorites/{productId}/check`
  - `AccountPage`, `ProductDetail` 에서 사용.
  - 이번 단계에서는 **프론트 임시 데이터/에러 처리로 동작**하고, 별도 도메인(`favorites`)으로 추후 설계 가능합니다.

- **Instagram 연동**
  - Supabase Functions 기준:
    - `/instagram/settings`, `/instagram/featured-image`, `/instagram/media`
  - `InstagramSettings`, `InstagramFeed` 에서 사용.
  - 이 기능은 마케팅/브랜딩 성격이 강하므로, 핵심 커머스 플로우와 분리하여 다음 단계에서 백엔드로 마이그레이션합니다.

- **리뷰, 쿠폰, 포인트, 알림 등**
  - `DATABASE_SCHEMA.sql` 상 테이블 (`reviews`, `coupons`, `notifications`, `product_views` …)은 설계되어 있지만,
    현재 프론트에서 필수 플로우로 사용하지 않으므로 이번 설계에서 제외했습니다.
  - 필요 시 별도 문서(`백앤드_설계_확장.md` 등)를 만들어 도메인별로 확장 설계를 진행할 수 있습니다.

---

## 9. 정리

- 이 문서는 **프론트엔드가 이미 기대하고 있는 API 계약**을 기준으로, FastAPI 백엔드에서 구현해야 하는 **최소한의 도메인/스키마/엔드포인트**를 정의합니다.
- 실제 구현 단계에서는:
  - 이 문서의 도메인 구조에 맞게 `feature1/2/3` 폴더를 `products/cart/orders` 역할로 리팩터링하고,
  - `core` 모듈(`database.py`, `models.py`, `security.py`)을 정리한 뒤,
  - 각 `router.py`/`schemas.py`/`service.py` 에 이 문서의 계약을 그대로 옮겨 구현하면 됩니다.
- 이후에는 이 설계를 확장하여 위시리스트, 리뷰, 쿠폰/포인트, 인스타그램 등 부가 기능을 단계적으로 추가할 수 있습니다.


